# 自动刷新令牌功能实现说明

## 📋 功能概述

本次更新为Vue项目的认证系统添加了完整的自动刷新令牌机制，解决了用户在使用过程中因访问令牌过期而需要重新登录的问题。

## ✨ 主要功能

### 1. 自动检测401错误并刷新令牌
- 当API请求返回401未授权错误时，系统会自动尝试使用refresh token刷新access token
- 刷新成功后会自动重试原始请求，用户无感知
- 刷新失败时会清除所有认证信息并跳转到首页

### 2. 主动刷新机制
- 在发送请求前检查access token是否即将过期（默认提前5分钟）
- 如果即将过期，会主动刷新token，避免请求失败
- 支持自定义提前刷新的时间缓冲

### 3. 防止竞态条件
- 使用Promise缓存机制，确保多个并发请求不会同时触发token刷新
- 当有刷新请求正在进行时，其他请求会等待刷新完成

### 4. 完整的错误处理
- 刷新失败时自动清除所有认证信息
- 自动跳转到首页，避免用户停留在需要认证的页面
- 提供友好的错误提示

## 🔧 技术实现

### 修改的文件
- `src/utils/auth.js` - 主要实现文件

### 新增的功能

#### 1. ApiClient类增强
```javascript
class ApiClient {
  constructor() {
    this.baseURL = ''
    this.refreshPromise = null  // 防止并发刷新
    this.isRefreshing = false
  }
}
```

#### 2. 自动刷新逻辑
```javascript
// 在request方法中添加401错误处理
if (response.status === HTTP_STATUS.UNAUTHORIZED && !isRetry && !url.includes('/refresh/')) {
  await this.handleTokenRefresh()
  return this.request(url, options, true) // 重试请求
}
```

#### 3. 主动刷新检测
```javascript
// 检查token是否快过期
if (this.isTokenExpiringSoon()) {
  await this.handleTokenRefresh()
}
```

#### 4. Token过期时间管理
```javascript
// 保存token时同时保存过期时间
const expiresAt = new Date(Date.now() + 30 * 60 * 1000) // 30分钟
CookieManager.setCookie(TOKEN_KEYS.ACCESS_TOKEN_EXPIRES, expiresAt.getTime().toString(), 1)
```

## 📊 配置参数

### Token过期时间
- **Access Token**: 30分钟（符合API文档规范）
- **Refresh Token**: 7天（Cookie过期时间）
- **提前刷新缓冲**: 5分钟（可配置）

### Cookie存储键名
```javascript
const TOKEN_KEYS = {
  ACCESS_TOKEN: 'sodesign_access_token',
  REFRESH_TOKEN: 'sodesign_refresh_token',
  ACCESS_TOKEN_EXPIRES: 'sodesign_access_token_expires',
  USER_INFO: 'sodesign_user_info'
}
```

## 🔄 工作流程

### 正常请求流程
1. 检查token是否即将过期
2. 如果即将过期，主动刷新token
3. 添加Authorization头
4. 发送请求
5. 返回结果

### 401错误处理流程
1. 收到401错误
2. 检查是否为重试请求（避免无限循环）
3. 检查是否为刷新token请求（避免递归）
4. 调用handleTokenRefresh()
5. 刷新成功后重试原请求
6. 刷新失败则清除认证信息并跳转

### 并发请求处理
1. 第一个请求触发刷新，创建refreshPromise
2. 后续请求检测到refreshPromise存在，等待其完成
3. 刷新完成后，所有等待的请求继续执行

## 🧪 测试用例

创建了完整的测试文件 `src/utils/auth.test.js`，包含以下测试场景：

1. **401错误自动刷新测试**
   - 验证收到401错误时能自动刷新token
   - 验证刷新成功后能重试原请求

2. **主动刷新测试**
   - 验证token快过期时能主动刷新
   - 验证刷新后的token被正确保存

3. **并发请求测试**
   - 验证多个并发请求只触发一次刷新
   - 验证防竞态条件机制正常工作

4. **刷新失败处理测试**
   - 验证刷新失败时清除认证信息
   - 验证自动跳转到首页

5. **过期时间检测测试**
   - 验证过期时间检测逻辑正确
   - 验证自定义缓冲时间功能

## 🚀 使用方法

### 自动功能
所有功能都是自动的，无需手动调用：
- 发送任何API请求时会自动检查和刷新token
- 收到401错误时会自动处理
- Token即将过期时会自动刷新

### 手动检查（可选）
```javascript
import { authUtils } from './utils/auth.js'

// 检查token是否即将过期
if (authUtils.isTokenExpiringSoon()) {
  console.log('Token即将过期')
}

// 自定义缓冲时间（10分钟）
if (authUtils.isTokenExpiringSoon(10)) {
  console.log('Token在10分钟内过期')
}
```

## 🔒 安全考虑

1. **防止无限循环**: 通过isRetry参数防止401错误处理的无限循环
2. **防止递归刷新**: 刷新token的请求不会触发自动刷新逻辑
3. **并发安全**: 使用Promise缓存防止多个请求同时刷新
4. **失败处理**: 刷新失败时立即清除所有认证信息
5. **时间验证**: 基于服务器时间的过期检测，避免客户端时间不准确

## 📈 性能优化

1. **主动刷新**: 避免请求失败，提升用户体验
2. **并发控制**: 防止重复刷新请求，节省网络资源
3. **缓存机制**: 使用Promise缓存，避免重复处理
4. **最小化存储**: 只存储必要的过期时间信息

## 🎯 用户体验

1. **无感知刷新**: 用户无需关心token过期问题
2. **自动重试**: 请求失败时自动重试，减少错误
3. **快速响应**: 主动刷新避免等待时间
4. **友好提示**: 刷新失败时提供清晰的错误信息

## 🔧 维护建议

1. **监控刷新频率**: 关注token刷新的频率和成功率
2. **调整缓冲时间**: 根据网络环境调整提前刷新时间
3. **错误日志**: 记录刷新失败的原因和频率
4. **性能监控**: 监控自动刷新对性能的影响

## 📝 总结

本次实现的自动刷新令牌机制提供了：
- ✅ 完全自动化的token管理
- ✅ 强大的错误处理和恢复机制
- ✅ 优秀的用户体验
- ✅ 完整的测试覆盖
- ✅ 高度的安全性和可靠性

用户现在可以长时间使用应用而无需担心token过期问题，系统会在后台自动处理所有token相关的操作。
